<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moon Messenger - Chat Test</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:'Vazirmatn',sans-serif;margin:0;padding:0;}
body{height:100vh;background:radial-gradient(circle at top,#0f2027,#000814);color:white;display:flex;justify-content:center;align-items:center;}
.glass{background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);border-radius:18px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 0 30px rgba(79,195,247,0.25);}
#chat{width:90%;max-width:360px;padding:20px;display:flex;flex-direction:column;height:80vh;}
#messages{flex:1;overflow-y:auto;padding:10px;margin-bottom:10px;}
.msg{margin-bottom:8px;padding:10px 14px;border-radius:14px;max-width:75%;}
.me{background:rgba(79,195,247,0.35);margin-left:auto;}
.other{background:rgba(255,255,255,0.15);margin-right:auto;}
#sendBox{display:flex;gap:8px;}
#sendBox input{flex:1;padding:10px;border-radius:12px;border:none;background:rgba(255,255,255,0.15);color:white;}
#sendBox button{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(135deg,#4fc3f7,#2196f3);color:black;font-weight:bold;cursor:pointer;}
#sendBox button:active{transform:scale(0.96);}
</style>
</head>

<body>

<div id="chat" class="glass">
  <div id="messages"></div>
  <div id="sendBox">
    <input id="msgInput" placeholder="پیام بنویس...">
    <button onclick="sendMsg()">ارسال</button>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  "https://qhbwyvohchhdlrpdmdpq.supabase.co",
  "sb_publishable_BMWofI5IbrvIrqG2k91sEg_Nt1sV3LL"
);

let username = prompt("اسم خودت رو وارد کن"); 
if(!username) username = "Guest";

async function loadMessages() {
  const { data } = await supabase.from("messages").select("*").order("created_at",{ascending:true});
  data.forEach(addMessage);
}

async function sendMsg() {
  const input = document.getElementById("msgInput");
  if(!input.value) return;
  await supabase.from("messages").insert([{sender:username,content:input.value}]);
  input.value="";
}

function addMessage(m) {
  const div = document.createElement("div");
  div.className = "msg " + (m.sender===username?"me":"other");
  div.innerText = m.sender + ": " + m.content;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

function subscribe() {
  supabase.channel('chat')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>addMessage(payload.new))
    .subscribe();
}

// load existing messages + realtime subscribe
loadMessages();
subscribe();
</script>

</body>
</html>
